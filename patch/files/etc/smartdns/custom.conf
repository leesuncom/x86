# 客户端设备
#     ↓
# Dnsmasq (端口 53) → 接收所有客户端DNS请求
#     ↓
# MosDNS (端口 7755) → 核心分流器
#    ├─ 国内域名 → SmartDNS (国内组，端口6053) → 国内DNS服务器
#    └─ 国外域名 → MosDNS 直接处理 → DNSCrypt-proxy (端口7058) → 国外DNS服务器# 证书生成

# openssl req -x509 -newkey rsa:2048 -nodes \
#  -keyout /etc/dnscrypt-proxy2/mosdns-key.pem \
#  -out /etc/dnscrypt-proxy2/mosdns-cert.pem \
#  -days 3650 \
#  -subj "/CN=mosdns" \
#  -addext "subjectAltName=DNS:smartdns,IP:127.0.0.1" 
# 将自签名证书追加到系统 CA 捆绑包末尾：
# cat /etc/dnscrypt-proxy2/mosdns-cert.pem >> /etc/ssl/certs/ca-certificates.crt
# ln -sf /etc/ssl/certs/ca-certificates.crt /etc/ssl/cert.pem
# 生成spki
# openssl x509 -in  /etc/dnscrypt-proxy2/mosdns-cert.pem -pubkey -noout | openssl pkey -pubin -outform der |  openssl dgst -sha256 -binary | openssl enc -base64
# 查看证书的CN和SAN
# openssl x509 -in /etc/dnscrypt-proxy2/mosdns-cert.pem -noout -subject -ext subjectAltName
# 验证配置
# dig @127.0.0.1 -p 7755 google.com

# ===== 基本设置 =====
server-name smartdns

# 服务器绑定配置（国内组：60xx 端口，海外组：70xx 端口）
bind :6053 -group china -no-speed-check -no-dualstack-selection
bind-tls :6055 -group china -no-speed-check -no-dualstack-selection
bind-https :6057 -group china -no-speed-check -no-dualstack-selection

bind :7053 -group oversea -no-speed-check -no-dualstack-selection
bind-tls :7055 -group oversea -no-speed-check -no-dualstack-selection
bind-https :7057 -group oversea -no-speed-check -no-dualstack-selection

# ===== 日志配置 =====
log-level debug
log-size 512K
log-num 1
log-file /tmp/log/smartdns.log  

# ===== 缓存配置 =====
cache-size 2048
cache-persist yes
cache-file /etc/smartdns/smartdns.cache
cache-checkpoint-time 1800
rr-ttl-min 300
rr-ttl-max 86400

# ===== 证书配置 =====
ca-file /etc/ssl/certs/ca-certificates.crt
ca-path /etc/ssl/certs/

# ===== DNS 处理策略 =====
serve-expired no
prefetch-domain no
force-AAAA-SOA yes
force-qtype-SOA 65
dualstack-ip-selection no
dnsmasq-lease-file /dev/null
# 优先连接速度最快的 IP
response-mode first-ping  

# ===== 防污染加固 =====
# 屏蔽私有IP地址空间的虚假响应
bogus-nxdomain 0.0.0.0/8
bogus-nxdomain 10.0.0.0/8
# bogus-nxdomain 172.16.0.0/12
# bogus-nxdomain 192.168.0.0/16
bogus-nxdomain 169.254.0.0/16

# 屏蔽本地链路和多播地址
bogus-nxdomain 127.0.0.0/8
bogus-nxdomain 224.0.0.0/4
bogus-nxdomain 240.0.0.0/4

# 屏蔽常见虚假响应地址
bogus-nxdomain 100.100.100.100/32  # 某些ISP的劫持地址
bogus-nxdomain 198.105.244.228/32  # 常见污染IP
bogus-nxdomain 198.105.254.228/32  # 常见污染IP

# 允许路由器本地IP（避免屏蔽您自己的路由器）
whitelist-ip 192.168.1.1/32

# 添加IP集规则防止DNS污染（如果文件存在）
ip-set -name china-ipv4 -file /etc/smartdns/ip-set/china_ip_list.txt
ip-set -name cloudflare-ipv4 -file /etc/smartdns/ip-set/cloudflare-ipv4.txt

# ===== 域名规则 =====
conf-file /etc/smartdns/domain-set/domains.china.smartdns.conf
conf-file /etc/smartdns/domain-set/proxy-domain-list.conf
conf-file /etc/smartdns/conf.d/anti-ad-smartdns.conf
hosts-file /etc/hosts

domain-rules /lan/ -address #
domain-rules /local/ -address #
domain-rules -c /./ -group china  # 默认走国内组，需海外解析的域名通过端口指定

address /ddns.com/192.168.1.1
address /router.lan/192.168.1.1
address /wpad.lan/#
address /invalid/#
address #6

# ===== 引导DNS配置（仅用于解析download.dnscrypt.info，防泄漏） =====
# 主引导：腾讯备用DNS（119.29.29.29，全运营商兼容）
# server-tls 120.53.53.53:853 -spki-pin 5TIMjgyMhA0qmPdK+AM9LX6vNI/9EPBydh/ZXdfcYmI= -bootstrap-dns -exclude-default-group
# server 119.29.29.29 -bootstrap-dns -exclude-default-group
# 添加备用引导 DNS
server-tls 223.5.5.5:853 -bootstrap-dns -exclude-default-group -spki-pin pa14rFR/bBJ25OSjCswaXu6YKWgQ2BDY5jhRRicqeik=
# 备用引导：电信ISP专用DNS（202.103.24.68，电信用户优先，其他运营商备用）
# server 202.103.24.68 -bootstrap-dns -exclude-default-group

# ===== 代理配置 =====
# proxy-server socks5://127.0.0.1:7898 -name socks5

# ===== 国内 DNS 组 =====
server-tls dot.360.cn:853 -spki-pin i9WtbILFhlaOnx0OLF9BCBZ2Wr1tisRc1YGmLHAAjQA= -group china -exclude-default-group 
# server-tls 120.53.53.53:853 -spki-pin 5TIMjgyMhA0qmPdK+AM9LX6vNI/9EPBydh/ZXdfcYmI= -group china -exclude-default-group
server-https https://120.53.53.53:443/dns-query -spki-pin 5TIMjgyMhA0qmPdK+AM9LX6vNI/9EPBydh/ZXdfcYmI= -group china -exclude-default-group
# server-https https://223.5.5.5:443/dns-query -spki-pin pa14rFR/bBJ25OSjCswaXu6YKWgQ2BDY5jhRRicqeik= -group china -exclude-default-group

# ===== 海外 DNS 组 =====
# 新配置：将海外组查询转发到 dnscrypt-proxy2（127.0.0.1:5353）
# 海外组使用 MosDNS
# server 127.0.0.1:7755 -group oversea  # MosDNS UDP 端口
# server-tls 127.0.0.1:7353 -group oversea -spki-pin 7sDVvQ+Y+Dk0DCtxOFBWy8HM02MFhlN4SvIO4/EkgFk= -host-name smartdns -http-host 127.0.0.1  # MosDNS TCP/TLS 端口
# server-https https://127.0.0.1:5557/dns-query -group oversea -spki-pin 7sDVvQ+Y+Dk0DCtxOFBWy8HM02MFhlN4SvIO4/EkgFk= -host-name smartdns -http-host 127.0.0.1
# server-https https://127.0.0.1:7058/dns-query -group oversea -spki-pin 7sDVvQ+Y+Dk0DCtxOFBWy8HM02MFhlN4SvIO4/EkgFk= -host-name smartdns -http-host 127.0.0.1

# 海外组 → 本地 dnscrypt-proxy2 的 DoH 服务（127.0.0.1:7058）
# openssl x509 -in  /etc/dnscrypt-proxy2/mosdns-cert.pem -pubkey -noout | openssl pkey -pubin -outform der |  openssl dgst -sha256 -binary | openssl enc -base64
# openssl req -x509 -newkey rsa:2048 -keyout /etc/dnscrypt-proxy2/mosdns-key.pem -out /etc/dnscrypt-proxy2/smartdns-cert.pem -days 3650 -nodes -subj "/O=smartdns/CN=smartdns" -addext "subjectAltName=DNS:smartdns,IP:127.0.0.1"
# server-https https://127.0.0.1:7058/dns-query -group oversea -spki-pin 7sDVvQ+Y+Dk0DCtxOFBWy8HM02MFhlN4SvIO4/EkgFk= -host-name smartdns -http-host 127.0.0.1

# 备用海外服务器（注释掉，仅在单独smartdns时使用，dnscrypt-proxy2开启时不可用时启用）
# ===== 海外 DNS 组（全部加代理，显式指定 443 端口） =====
# Cloudflare DoT + DoH
# server-tls 1.1.1.1:853 -spki-pin SPfg6FluPIlUc6a5h313BDCxQYNGX+THTy7ig5X3+VA= -group oversea
# server-https https://cloudflare-dns.com:443/dns-query -spki-pin SPfg6FluPIlUc6a5h313BDCxQYNGX+THTy7ig5X3+VA= -group oversea
# AdGuard 无过滤 DoH
# server-https https://dns-unfiltered.adguard.com:443/dns-query -spki-pin dN753nSb1bPC9fzU/V/+a0R1NQ+QnZjN8uBHhBMKfDM= -group oversea
# Google DoT + DoH
# server-tls 8.8.8.8:853 -spki-pin WoiWRyIOVNa9ihaBciRSC7XHjliYS9VwUGOIud4PB18= -group oversea
# server-tls 8.8.4.4:853 -spki-pin WoiWRyIOVNa9ihaBciRSC7XHjliYS9VwUGOIud4PB18= -group oversea
# server-https https://dns.google:443/dns-query -spki-pin WoiWRyIOVNa9ihaBciRSC7XHjliYS9VwUGOIud4PB18= -group oversea
# Quad9 DoH
# server-https https://dns.quad9.net:443/dns-query -spki-pin lCppFqbkrlJ3EcVFAkeip0+44VaoJUymbnOaEUk7tEU= -group oversea
